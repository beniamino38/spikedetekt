<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Spikedetekt by klusta-team</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Spikedetekt</h1>
        <p></p>

        <p class="view"><a href="https://github.com/klusta-team/spikedetekt">View the Project on GitHub <small>klusta-team/spikedetekt</small></a></p>


        <ul>
          <li><a href="https://github.com/klusta-team/spikedetekt/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/klusta-team/spikedetekt/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/klusta-team/spikedetekt">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>SpikeDetekt</h2>

<p>This is a program for spike detection. It is in development.</p>

<p>Contact: Kenneth Harris (firstname at cortexlab.net), Shabnam Kadir (firstname at cortexlab.net)</p>

<h2>Quick Start Guide for electrophysiologists (will become more comprehensive with time):</h2>

<h2>0) Installation</h2>

<p>We recommend you use Python 2.6 or 2.7, e.g. a free academic version can be obtained from <a href="http://enthought.com/products/epd.php">Enthought Python</a>.</p>

<p>Once you have set up Python on your system, go to the SpikeDetekt folder and type (on the command line):</p>

<pre><code>python setup.py install
</code></pre>

<p>This will install SpikeDetekt.</p>

<h2>1) Probefiles:</h2>

<p>Below are the instructions for a multi-shank probe (I hope this is clear from my example probe - otherwise do ask):</p>

<p>Construct a probe object from a .probe file with:</p>

<p>probe = Probe(filename)</p>

<p>The file should have a form something like:</p>

<pre><code>probes = {
    1: [
        (0, 1), (0, 2),
        (1, 2), (1, 3),
        ...
        ],
    2: [...],
    ...
    }
</code></pre>

<p>The file is a Python file which should define a dictionary variable probes,
with keys the shank number, and values a list of channel pairs defining the
edges of the graph.</p>

<p>The Probe object has the following attributes:</p>

<ul>
<li><p>num_channels<br>
The number of channels used (1+the maximum channel number referred to)</p></li>
<li><p>channel_graph 
A dictionary with keys the shank number, and values being graphs. A graph being a dictionary with keys the nodes (channel number) and values the set of all connected nodes. (So each channel in an edge is referred to twice in this data structure.)</p></li>
<li><p>shanks_set
   The set of shank numbers</p></li>
<li><p>channel_set
   A dictionary with keys the shank numbers, and values the 
set of channels for that shank</p></li>
<li><p>channel_to_shank
   A dictionary with keys the channel numbers and values the corresponding shank number.</p></li>
<li><p>probes
   The raw probes dictionary definition in the file.</p></li>
</ul><p>I have included some examples of probe files:</p>

<ul>
<li>buzsaki32.probe</li>
<li>linear16.probe</li>
<li>multishankslinear32.probe (an 8 shank example)</li>
</ul><h2>2) Parameters to adjust</h2>

<p>Create a file called filename.params where filename is the name of your desired output folder. It should 
have the same form as the defaultparameters.py file in /spikedetekt/spikedetket/. It should contain the 
following minimal information:</p>

<pre><code>DTYPE = "i2" # "&gt;i2" (&gt; means big-endian), "i4", "f2"
# see http://docs.scipy.org/doc/numpy/reference/arrays.dtypes.html#arrays-dtypes-constructing

# Probe file (no default value provided)
PROBE_FILE = 'probe_filename.probe'

# Raw data files (no default values provided)
RAW_DATA_FILES = ['file1.dat', 'file2.dat','file3.dat']
NCHANNELS = 32
SAMPLERATE = 20000 # in Hertz
</code></pre>

<p>You can specify an ordered list of .dat files to be concatenated, in the above example file1.dat, file2.dat and file3.dat are three
recordings to be concatenated. The output files will be written to a folder
called `filename', where filename.params is the name of your parameters file. </p>

<p>The default parameters are as follows (see /spikedetekt/defaultparameters.py and change as desired):</p>

<pre><code>DTYPE = "i2" # "&gt;i2" (&gt; means big-endian), "i4", "f2"
# see http://docs.scipy.org/doc/numpy/reference/arrays.dtypes.html#arrays-dtypes-constructing

# Probe file (no default value provided)
#PROBE_FILE = 'probe_filename.probe'

# Raw data files (no default values provided)
#RAW_DATA_FILES = ['file1.dat', 'file2.dat']
#NCHANNELS = 32
#SAMPLERATE = 20000 # in Hertz

# Output directory, files are inserted in OUTPUT_DIR/OUTPUT_NAME
OUTPUT_DIR = None # the output directory, use params directory if None
OUTPUT_NAME = None # the filename for created directories, use params filename if None

# Thresholding
USE_SINGLE_THRESHOLD = False # use a single threshold for all channels
CHUNKS_FOR_THRESH = 5 # number of chunks used to determine threshold for detection
THRESH_SD = 4.5 # threshold for detection. standard deviations of signal
DETECT_POSITIVE = False # detect spikes with positive threshold crossing

# Recording data in HDF5 file
RECORD_RAW = True      # raw data
RECORD_HIGH = True     # high pass filtered data
RECORD_LOW = True      # low pass filtered data

# Options for filtering
F_LOW = 500. # low pass frequency (Hz)
BUTTER_ORDER = 3 # Order of butterworth filter
WRITE_FIL_FILE = True # write filtered output to .fil file

# Options for spike detection
T_BEFORE = .0005 # time before peak in extracted spike
T_AFTER = .0005 # time after peak in extracted spike
T_JOIN_CC = .0005 # maximum time between two samples for them to be "contiguous" in detection step
PENUMBRA_SIZE = 0 # mask penumbra size (0 no penumbra, 1 first neighbours, etc.)

# Options for alignment
USE_WEIGHTED_MEAN_PEAK_SAMPLE = True # used for aligning waves
UPSAMPLING_FACTOR = 10 # used for aligning waves

# Options for features
FPC = 3 # Features per channel
PCA_MAXWAVES = 10000 # number of waves to use to extract principal components
SHOW_PCS = False # show principal components

# Options for masking
USE_FLOAT_MASKS = True
USE_INTERPOLATION = True
ADDITIONAL_FLOAT_PENUMBRA = 2 # adds some more penumbra
FLOAT_MASK_THRESH_SD = (0, 4.5) # (min, max), mask 0 at min, 1 at max
FLOAT_MASK_INTERPOLATION = 'x' # f(x) for x in [0,1], f(0)=0, f(1)=1

# Options for computing in chunks
CHUNK_SIZE = 20000   # number of time samples used in chunk for filtering and detection
CHUNK_OVERLAP_SECONDS = 0.01 # overlap time (in seconds) of chunks, should be wider than spike width

# Maximum number of spikes to process
MAX_SPIKES = None # None for all spikes, or an int

# Experimental options
DO_GLOBAL_CLUSTERING = False
SORT_CLUS_BY_CHANNEL = False # Sort clusters by the channel where the peak occurs
</code></pre>

<p>If you need parameters which differ from the default, include these in your filename.params files. </p>

<h2>3) Running</h2>

<p>Finally to run the program type:</p>

<pre><code>python SpiKeDeteKt/scripts/detektspikes.py filename.params
</code></pre>

<h2>4) Output</h2>

<p>SpiKeDeteKt will output the following files, where n is your shank number:</p>

<ol>
<li>.fet.n (feature file - required for all versions of KlustaKwik)</li>
</ol><ul>
<li><p>.mask.n (binary masks for using with the new (masked) KlustaKwik)</p></li>
<li><p>.fmask.n (trial - float masks instead of binary, we are using this for testing masked KlustaKwik)</p></li>
<li><p>.spk.n (spike file)</p></li>
<li><p>.upsk.n (unfiltered spike waveform)</p></li>
<li><p>.res.n (list of spike times)</p></li>
<li><p>.clu.n (a trivial clu file for use with Neuroscope, for observing spikes after detection, before clustering. Will be made redundant later)</p></li>
<li><p>.xml (an xml file with all the parameters that can subsequently be used by Neuroscope or Klusters)</p></li>
<li><p>.fil (highpass filtered data)</p></li>
<li><p>.h5 files (an <a href="http://en.wikipedia.org/wiki/Hierarchical_Data_Format">.h5</a> file duplicating a lot of the above data, which will later replace the above).
.high.h5,
.low.h5,
.waves.h5,
.main.h5,
.raw.h5. (See spikdetekt/docs/fileformat.md for more details).</p></li>
</ul>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/klusta-team">klusta-team</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>